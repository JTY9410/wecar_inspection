{% extends "base.html" %}

{% block title %}로그인 - 위카아라이 검수시스템{% endblock %}

{% block content %}
<div class="login-container">
    <div class="login-box">
        <div class="text-center mb-4">
            <img src="{{ url_for('static', filename='images/lpgo.png') }}" alt="위카 로고" class="logo-img mb-3">
            <h2 class="fw-bold mb-4">WECAR INSPECTION</h2>
        </div>
        
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">아이디</label>
                <input type="text" class="form-control" id="username" name="username" required autocomplete="username">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" class="form-control" id="password" name="password" required autocomplete="current-password">
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-lg flex-fill">로그인</button>
                <button type="button" class="btn btn-outline-secondary btn-lg flex-fill" data-bs-toggle="modal" data-bs-target="#registerModal">회원가입</button>
            </div>
        </form>
    </div>
</div>

<!-- 회원가입 모달 -->
<div class="modal fade" id="registerModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-plus"></i> 회원가입
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="mb-3">
                        <label for="register_user_type" class="form-label">
                            회원가입구분 <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="register_user_type" name="user_type" required>
                            <option value="">선택하세요</option>
                            <option value="검수신청">검수신청</option>
                            <option value="평가사">평가사</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="register_username" class="form-label">
                            아이디 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="register_username" name="username" required autocomplete="username">
                    </div>
                    <div class="mb-3">
                        <label for="register_password" class="form-label">
                            패스워드 <span class="text-danger">*</span>
                        </label>
                        <input type="password" class="form-control" id="register_password" name="password" required autocomplete="new-password">
                    </div>
                    <div class="mb-3">
                        <label for="register_password_confirm" class="form-label">
                            패스워드확인 <span class="text-danger">*</span>
                        </label>
                        <input type="password" class="form-control" id="register_password_confirm" name="password_confirm" required autocomplete="new-password">
                        <div class="form-text" id="passwordMatchText"></div>
                    </div>
                    <div class="mb-3">
                        <label for="register_company" class="form-label">회사</label>
                        <input type="text" class="form-control" id="register_company" name="company" autocomplete="organization">
                    </div>
                    <div class="mb-3">
                        <label for="register_position" class="form-label">직책</label>
                        <input type="text" class="form-control" id="register_position" name="position" autocomplete="organization-title">
                    </div>
                    <div class="mb-3">
                        <label for="register_name" class="form-label">
                            이름 <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="register_name" name="name" required autocomplete="name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="registerSubmitBtn">
                    <i class="bi bi-person-plus"></i> 가입신청
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 로그인 폼 제출
    $('#loginForm').on('submit', function(e) {
        e.preventDefault();
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        
        // 로딩 상태
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 로그인 중...');
        
        $.ajax({
            url: '{{ url_for("login") }}',
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);
                if (response.success) {
                    window.location.href = response.redirect;
                } else {
                    // 승인 미완료 시 팝업창 표시
                    if (response.message && response.message.includes('회원가입승인이 미완료')) {
                        $('#approvalPendingModal').modal('show');
                    } else {
                        alert(response.message);
                    }
                }
            },
            error: function() {
                submitBtn.prop('disabled', false).html(originalText);
                alert('로그인 중 오류가 발생했습니다.');
            }
        });
    });
    
    // 회원가입 폼 제출
    $('#registerSubmitBtn').on('click', function() {
        const formData = {
            user_type: $('#register_user_type').val(),
            username: $('#register_username').val(),
            password: $('#register_password').val(),
            password_confirm: $('#register_password_confirm').val(),
            company: $('#register_company').val(),
            position: $('#register_position').val(),
            name: $('#register_name').val()
        };
        
        // 유효성 검사
        if (!formData.user_type) {
            alert('회원가입구분을 선택해주세요.');
            return;
        }
        if (!formData.username) {
            alert('아이디를 입력해주세요.');
            return;
        }
        if (!formData.password) {
            alert('비밀번호를 입력해주세요.');
            return;
        }
        if (formData.password !== formData.password_confirm) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }
        if (!formData.name) {
            alert('이름을 입력해주세요.');
            return;
        }
        
        const submitBtn = $(this);
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 처리 중...');
        
        $.ajax({
            url: '{{ url_for("register") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                submitBtn.prop('disabled', false).html(originalText);
                alert(response.message);
                if (response.success) {
                    $('#registerModal').modal('hide');
                    $('#registerForm')[0].reset();
                }
            },
            error: function() {
                submitBtn.prop('disabled', false).html(originalText);
                alert('회원가입 중 오류가 발생했습니다.');
            }
        });
    });
    
    // Enter 키로 로그인
    $('#username, #password').on('keypress', function(e) {
        if (e.which === 13) {
            $('#loginForm').submit();
        }
    });
    
    // 비밀번호 확인 일치 여부 체크
    $('#register_password_confirm').on('keyup', function() {
        const password = $('#register_password').val();
        const passwordConfirm = $(this).val();
        const matchText = $('#passwordMatchText');
        
        if (passwordConfirm.length > 0) {
            if (password === passwordConfirm) {
                matchText.html('<i class="bi bi-check-circle text-success"></i> 비밀번호가 일치합니다.').removeClass('text-danger').addClass('text-success');
            } else {
                matchText.html('<i class="bi bi-x-circle text-danger"></i> 비밀번호가 일치하지 않습니다.').removeClass('text-success').addClass('text-danger');
            }
        } else {
            matchText.html('');
        }
    });
    
    // 모달이 닫힐 때 폼 초기화
    $('#registerModal').on('hidden.bs.modal', function() {
        $('#registerForm')[0].reset();
        $('#passwordMatchText').html('');
    });
});
</script>

<!-- 회원가입 승인 미완료 모달 -->
<div class="modal fade" id="approvalPendingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> 회원가입 승인 대기
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="bi bi-info-circle fs-1 text-warning mb-3"></i>
                <p class="fs-5">회원가입승인이 미완료 되었습니다</p>
                <p class="text-muted">완료후 이용하여주세요</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

