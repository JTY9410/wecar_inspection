{% extends "base.html" %}

{% block title %}회원관리 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-people"></i> 회원관리</h2>
            <div>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-house"></i> 관리자메인페이지로
                </a>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="bi bi-person-plus"></i> 신규추가
                </button>
            </div>
        </div>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead class="table-fixed-header">
                <tr>
                    <th>순</th>
                    <th>회원가입구분</th>
                    <th>가입일자</th>
                    <th>아이디</th>
                    <th>패스워드</th>
                    <th>패스워드확인</th>
                    <th>이메일</th>
                    <th>휴대폰</th>
                    <th>회사</th>
                    <th>직책</th>
                    <th>이름</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="row-{{ user.id }}">
                    <td>{{ loop.index }}</td>
                    <td>
                        <select class="form-select form-select-sm" name="user_type" disabled>
                            <option value="진단신청" {% if user.user_type == '진단신청' %}selected{% endif %}>진단신청</option>
                            <option value="평가사" {% if user.user_type == '평가사' %}selected{% endif %}>평가사</option>
                            <option value="관리자" {% if user.user_type == '관리자' %}selected{% endif %}>관리자</option>
                        </select>
                    </td>
                    <td>{{ user.created_at[:10] if user.created_at else '' }}</td>
                    <td><input type="text" class="form-control form-control-sm" name="username" value="{{ user.username }}" disabled></td>
                    <td><input type="password" class="form-control form-control-sm" name="password" value="" placeholder="변경시만 입력" disabled></td>
                    <td><input type="password" class="form-control form-control-sm" name="password_confirm" value="" placeholder="변경시만 입력" disabled></td>
                    <td><input type="email" class="form-control form-control-sm" name="email" value="{{ user.email or '' }}" disabled></td>
                    <td><input type="tel" class="form-control form-control-sm" name="phone" value="{{ user.phone or '' }}" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" name="company" value="{{ user.company or '' }}" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" name="position" value="{{ user.position or '' }}" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" name="name" value="{{ user.name }}" disabled></td>
                    <td>
                        <div class="btn-group-sm">
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ user.id }}">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            <button class="btn btn-sm btn-success save-btn" data-id="{{ user.id }}" style="display:none;">
                                <i class="bi bi-check"></i> 저장
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="{{ user.id }}">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 신규추가 모달 -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> 신규 회원 추가</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">회원가입구분 <span class="text-danger">*</span></label>
                            <select class="form-select" name="user_type" required>
                                <option value="">선택하세요</option>
                                <option value="진단신청">진단신청</option>
                                <option value="평가사">평가사</option>
                                <option value="관리자">관리자</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">아이디 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">패스워드 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">패스워드확인 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="password_confirm" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">이메일</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">휴대폰</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">회사</label>
                            <input type="text" class="form-control" name="company">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">직책</label>
                            <input type="text" class="form-control" name="position">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">이름 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="addUserSubmitBtn">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 수정 버튼
    $(document).on('click', '.edit-btn', function() {
        const id = $(this).data('id');
        const row = $(`#row-${id}`);
        row.addClass('editing');
        row.find('input, select').prop('disabled', false);
        $(this).hide();
        row.find('.save-btn').show();
    });
    
    // 저장 버튼
    $(document).on('click', '.save-btn', function() {
        const id = $(this).data('id');
        const row = $(`#row-${id}`);
        const password = row.find('[name="password"]').val();
        const passwordConfirm = row.find('[name="password_confirm"]').val();
        
        if (password && password !== passwordConfirm) {
            alert('패스워드가 일치하지 않습니다.');
            return;
        }
        
        const data = {
            id: id,
            user_type: row.find('[name="user_type"]').val(),
            username: row.find('[name="username"]').val(),
            password: password || null,
            password_confirm: passwordConfirm || null,
            email: row.find('[name="email"]').val() || null,
            phone: row.find('[name="phone"]').val() || null,
            name: row.find('[name="name"]').val(),
            company: row.find('[name="company"]').val() || null,
            position: row.find('[name="position"]').val() || null
        };
        
        $.ajax({
            url: '{{ url_for("admin_users_update") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    alert('저장되었습니다.');
                    // 행 비활성화
                    row.removeClass('editing');
                    row.find('input, select').prop('disabled', true);
                    row.find('.edit-btn').show();
                    row.find('.save-btn').hide();
                    // 패스워드 필드 초기화
                    row.find('[name="password"]').val('');
                    row.find('[name="password_confirm"]').val('');
                } else {
                    alert(response.message || '저장에 실패했습니다.');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert(response?.message || '저장 중 오류가 발생했습니다.');
            }
        });
    });
    
    // 삭제 버튼
    $('.delete-btn').on('click', function() {
        const id = $(this).data('id');
        if (confirm('정말 삭제하시겠습니까?')) {
            $.ajax({
                url: '{{ url_for("admin_users_delete") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({id: id}),
                success: function(response) {
                    if (response.success) {
                        alert('삭제되었습니다.');
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                }
            });
        }
    });
    
    // 신규추가
    $('#addUserSubmitBtn').on('click', function() {
        const formData = collectFormData('#addUserForm');
        if (!formData.user_type || !formData.username || !formData.password || !formData.name) {
            alert('필수 항목을 입력해주세요.');
            return;
        }
        if (formData.password !== formData.password_confirm) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }
        
        $.ajax({
            url: '{{ url_for("admin_users_create") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    alert('추가되었습니다.');
                    location.reload();
                } else {
                    alert(response.message);
                }
            }
        });
    });
});
</script>
{% endblock %}

