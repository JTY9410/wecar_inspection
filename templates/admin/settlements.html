{% extends "base.html" %}

{% block title %}정산관리 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-calculator"></i> 정산관리</h2>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> 관리자페이지로
            </a>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">년도</label>
                <input type="number" class="form-control" name="year" value="{{ year }}" min="2020" max="2100">
            </div>
            <div class="col-md-3">
                <label class="form-label">월</label>
                <input type="number" class="form-control" name="month" value="{{ month }}" min="1" max="12">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 조회
                </button>
                <button type="button" class="btn btn-info" id="viewModalBtn">
                    <i class="bi bi-eye"></i> 화면저장
                </button>
                <form method="POST" action="{{ url_for('admin_settlements_save') }}" style="display:inline;">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> 저장
                    </button>
                </form>
                <a href="{{ url_for('admin_settlements_export', fmt='xlsx', year=year, month=month) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> 엑셀저장
                </a>
                <a href="{{ url_for('admin_settlements_export', fmt='pdf', year=year, month=month) }}" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf"></i> PDF저장
                </a>
            </div>
        </form>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead class="table-fixed-header">
                <tr>
                    <th>일자</th>
                    <th>평가사</th>
                    <th>건수</th>
                    <th>금액</th>
                    <th>VAT</th>
                    <th>청구액</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for day, info in payload.days.items() %}
                {% for row in info.rows %}
                <tr>
                    <td>{{ day }}</td>
                    <td>{{ row.evaluator_name }}</td>
                    <td>{{ row.count }}</td>
                    <td>{{ "{:,}".format(row.amount) }}</td>
                    <td>{{ "{:,}".format(row.vat) }}</td>
                    <td>{{ "{:,}".format(row.grand) }}</td>
                    <td>
                        <div class="btn-group-sm">
                            <button class="btn btn-sm btn-outline-primary edit-row-btn" data-day="{{ day }}" data-evaluator="{{ row.evaluator_name }}">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            <button class="btn btn-sm btn-success save-row-btn" data-day="{{ day }}" data-evaluator="{{ row.evaluator_name }}" style="display:none;">
                                <i class="bi bi-check"></i> 저장
                            </button>
                            <button class="btn btn-sm btn-danger delete-row-btn" data-day="{{ day }}" data-evaluator="{{ row.evaluator_name }}">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                <tr class="table-secondary">
                    <td><strong>{{ day }} 소계</strong></td>
                    <td></td>
                    <td><strong>{{ info.subtotal_count }}</strong></td>
                    <td><strong>{{ "{:,}".format(info.subtotal_amount) }}</strong></td>
                    <td><strong>{{ "{:,}".format(info.subtotal_amount * 0.1|int) }}</strong></td>
                    <td><strong>{{ "{:,}".format(info.subtotal_amount + (info.subtotal_amount * 0.1|int)) }}</strong></td>
                </tr>
                {% endfor %}
                <tr class="table-primary">
                    <td><strong>총합</strong></td>
                    <td></td>
                    <td><strong>{{ payload.total_count }}</strong></td>
                    <td><strong>{{ "{:,}".format(payload.total_amount) }}</strong></td>
                    <td><strong>{{ "{:,}".format(payload.total_vat) }}</strong></td>
                    <td><strong>{{ "{:,}".format(payload.total_grand) }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    {% if saved_settlements %}
    <div class="mt-4">
        <h5>저장된 정산내역</h5>
        <div class="d-flex flex-wrap gap-2">
            {% for settlement in saved_settlements %}
            <a href="{{ url_for('admin_settlement_view', settlement_id=settlement.id) }}" class="btn btn-outline-primary">
                {{ settlement.title }} ({{ settlement.created_at[:10] }})
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- 화면저장 모달 -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">정산내역 화면저장</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-wrapper">
                    <table class="table table-bordered">
                        <thead class="table-fixed-header">
                            <tr>
                                <th>일자</th>
                                <th>평가사</th>
                                <th>건수</th>
                                <th>금액</th>
                                <th>VAT</th>
                                <th>청구액</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day, info in payload.days.items() %}
                            {% for row in info.rows %}
                            <tr>
                                <td>{{ day }}</td>
                                <td>{{ row.evaluator_name }}</td>
                                <td>{{ row.count }}</td>
                                <td>{{ "{:,}".format(row.amount) }}</td>
                                <td>{{ "{:,}".format(row.vat) }}</td>
                                <td>{{ "{:,}".format(row.grand) }}</td>
                            </tr>
                            {% endfor %}
                            <tr class="table-secondary">
                                <td><strong>{{ day }} 소계</strong></td>
                                <td></td>
                                <td><strong>{{ info.subtotal_count }}</strong></td>
                                <td><strong>{{ "{:,}".format(info.subtotal_amount) }}</strong></td>
                                <td><strong>{{ "{:,}".format(info.subtotal_amount * 0.1|int) }}</strong></td>
                                <td><strong>{{ "{:,}".format(info.subtotal_amount + (info.subtotal_amount * 0.1|int)) }}</strong></td>
                            </tr>
                            {% endfor %}
                            <tr class="table-primary">
                                <td><strong>총합</strong></td>
                                <td></td>
                                <td><strong>{{ payload.total_count }}</strong></td>
                                <td><strong>{{ "{:,}".format(payload.total_amount) }}</strong></td>
                                <td><strong>{{ "{:,}".format(payload.total_vat) }}</strong></td>
                                <td><strong>{{ "{:,}".format(payload.total_grand) }}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">이전페이지로</button>
                <form method="POST" action="{{ url_for('admin_settlements_save') }}" style="display:inline;">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-database"></i> 데이터베이스저장
                    </button>
                </form>
                <a href="{{ url_for('admin_settlements_export', fmt='xlsx', year=year, month=month) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> 엑셀저장
                </a>
                <a href="{{ url_for('admin_settlements_export', fmt='pdf', year=year, month=month) }}" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf"></i> PDF저장
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#viewModalBtn').on('click', function() {
        $('#viewModal').modal('show');
    });
});
</script>
{% endblock %}

