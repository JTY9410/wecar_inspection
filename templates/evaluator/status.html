{% extends "base.html" %}

{% block title %}신청현황 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-clipboard-list"></i> 신청현황</h2>
            <a href="{{ url_for('evaluator_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> 평가사대시보드 페이지로
            </a>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">시작일</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">종료일</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 검색
                </button>
                <a href="{{ url_for('evaluator_response_export', fmt='xlsx', start_date=start_date, end_date=end_date) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> 엑셀저장
                </a>
                <a href="{{ url_for('evaluator_response_export', fmt='pdf', start_date=start_date, end_date=end_date) }}" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf"></i> PDF저장
                </a>
            </div>
        </form>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead class="table-fixed-header">
                <tr>
                    <th>구분</th>
                    <th>신청일</th>
                    <th>차량번호</th>
                    <th>출품번호</th>
                    <th>주차번호</th>
                    <th>진단신청</th>
                    <th>평가사입력</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for req in requests %}
                <tr>
                    <td>
                        <span class="badge bg-{% if req.status == '신청' %}secondary{% elif req.status == '평가사배정' %}warning{% else %}success{% endif %}">
                            {{ req.status }}
                        </span>
                    </td>
                    <td>{{ req.request_date }}</td>
                    <td>{{ req.vehicle_number or '' }}</td>
                    <td>{{ req.lot_number or '' }}</td>
                    <td>{{ req.parking_number or '' }}</td>
                    <td class="text-summary">{{ req.vehicle_number or '' }}</td>
                    <td>{{ req.evaluator_name or '' }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary input-btn" data-id="{{ req.id }}" data-evaluator="{{ req.evaluator_name or '' }}">
                            <i class="bi bi-pencil"></i> 입력
                        </button>
                        {% if req.status == '평가사배정' %}
                        <button class="btn btn-sm btn-success complete-btn" data-id="{{ req.id }}">
                            <i class="bi bi-check-circle"></i> 평가완료
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 평가사 입력 모달 -->
<div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">평가사 입력</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">평가사 선택</label>
                    <select class="form-select" id="evaluatorSelect">
                        <option value="">선택하세요</option>
                        {% for evaluator in evaluators %}
                        <option value="{{ evaluator.id }}">{{ evaluator.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">또는 수기입력</label>
                    <input type="text" class="form-control" id="manualEvaluatorName" placeholder="평가사 이름을 입력하세요">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="assignEvaluatorBtn">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    setDefaultDateRange(7);
    let currentDiagnosisId = null;
    
    $('.input-btn').on('click', function() {
        currentDiagnosisId = $(this).data('id');
        const currentEvaluator = $(this).data('evaluator');
        if (currentEvaluator) {
            $('#evaluatorSelect').val('');
            $('#manualEvaluatorName').val(currentEvaluator);
        } else {
            $('#evaluatorSelect').val('');
            $('#manualEvaluatorName').val('');
        }
        $('#inputModal').modal('show');
    });
    
    $('#assignEvaluatorBtn').on('click', function() {
        const evaluatorId = $('#evaluatorSelect').val();
        const manualName = $('#manualEvaluatorName').val().trim();
        
        if (!evaluatorId && !manualName) {
            alert('평가사를 선택하거나 입력해주세요.');
            return;
        }
        
        $.ajax({
            url: '{{ url_for("evaluator_assign") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                diagnosis_id: currentDiagnosisId,
                evaluator_id: evaluatorId || null,
                manual_name: manualName
            }),
            success: function(response) {
                if (response.success) {
                    alert('저장되었습니다.');
                    location.reload();
                } else {
                    alert(response.message);
                }
            }
        });
    });
    
    $('.complete-btn').on('click', function() {
        const id = $(this).data('id');
        if (confirm('평가를 완료 처리하시겠습니까?')) {
            $.ajax({
                url: '{{ url_for("evaluator_complete") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({diagnosis_id: id}),
                success: function(response) {
                    if (response.success) {
                        alert('완료되었습니다.');
                        location.reload();
                    }
                }
            });
        }
    });
});
</script>
{% endblock %}


