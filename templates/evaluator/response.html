{% extends "base.html" %}

{% block title %}평가답변 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-pencil-square"></i> 평가답변</h2>
            <a href="{{ url_for('evaluator_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> 평가사대시보드페이지로
            </a>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">시작일</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">종료일</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 검색
                </button>
                <a href="{{ url_for('evaluator_response_export', fmt='xlsx', start_date=start_date, end_date=end_date) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> 엑셀저장
                </a>
                <a href="{{ url_for('evaluator_response_export', fmt='pdf', start_date=start_date, end_date=end_date) }}" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf"></i> PDF저장
                </a>
            </div>
        </form>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead class="table-fixed-header">
                <tr>
                    <th>순</th>
                    <th>신청일</th>
                    <th>상태</th>
                    <th>차량번호</th>
                    <th>출품번호</th>
                    <th>주차번호</th>
                    <th>진단신청내역</th>
                    <th>답변</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for item in requests %}
                {% set req = item.row %}
                <tr id="row-{{ req.id }}">
                    <td>{{ loop.index }}</td>
                    <td><input type="date" class="form-control form-control-sm" name="request_date" value="{{ req.request_date }}" disabled></td>
                    <td>
                        <select class="form-select form-select-sm" name="status" disabled>
                            <option value="신청" {% if req.status == '신청' %}selected{% endif %}>신청</option>
                            <option value="답변완료" {% if req.status == '답변완료' %}selected{% endif %}>답변완료</option>
                            <option value="전송완료" {% if req.status == '전송완료' %}selected{% endif %}>전송완료</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control form-control-sm" name="vehicle_number" value="{{ req.vehicle_number or '' }}" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" name="lot_number" value="{{ req.lot_number or '' }}" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" name="parking_number" value="{{ req.parking_number or '' }}" disabled></td>
                    <td class="text-summary">{{ item.request_summary or '' }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary response-btn" data-id="{{ req.id }}">
                            <i class="bi bi-pencil"></i> 답변
                        </button>
                    </td>
                    <td>
                        <div class="btn-group-sm">
                            <button class="btn btn-sm btn-outline-primary edit-row-btn" data-id="{{ req.id }}">
                                <i class="bi bi-pencil"></i> 수정
                            </button>
                            <button class="btn btn-sm btn-success save-row-btn" data-id="{{ req.id }}" style="display:none;">
                                <i class="bi bi-check"></i> 저장
                            </button>
                            <button class="btn btn-sm btn-danger delete-row-btn" data-id="{{ req.id }}">
                                <i class="bi bi-trash"></i> 삭제
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 답변 입력 팝업 모달 -->
<div class="modal fade" id="responseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 평가답변 입력</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="responseModalBody">
                <!-- 내용이 동적으로 로드됨 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">이전페이지로</button>
                <button type="button" class="btn btn-success" id="completeResponseBtn">
                    <i class="bi bi-check-circle"></i> 답변완료
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    setDefaultDateRange(7);
    let currentDiagnosisId = null;
    
    // 답변 버튼 클릭
    $('.response-btn').on('click', function() {
        currentDiagnosisId = $(this).data('id');
        $('#responseModalBody').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">로딩 중...</span></div></div>');
        $('#responseModal').modal('show');
        
        // 답변 폼 로드 (JSON API 사용)
        $.ajax({
            url: `/evaluator/response/${currentDiagnosisId}/json`,
            method: 'GET',
            success: function(response) {
                if (!response.success) {
                    $('#responseModalBody').html('<div class="alert alert-danger">' + (response.message || '답변 폼을 불러올 수 없습니다.') + '</div>');
                    return;
                }
                
                const diag = response.diagnosis;
                let tableRows = '';
                response.table_data.forEach(function(row) {
                    const hasResponse = row.response_content && row.response_content.trim() !== '';
                    tableRows += `
                        <tr data-seq="${row.sequence}">
                            <td>${row.sequence}</td>
                            <td>${row.request_content || ''}</td>
                            <td>
                                <textarea class="form-control response-content" name="content_${row.sequence}" rows="3" placeholder="답변을 입력하세요" ${hasResponse ? 'disabled' : ''}>${row.response_content || ''}</textarea>
                            </td>
                            <td>
                                <textarea class="form-control response-note" name="note_${row.sequence}" rows="2" placeholder="비고를 입력하세요" ${hasResponse ? 'disabled' : ''}>${row.note || ''}</textarea>
                            </td>
                            <td>
                                <div class="btn-group-sm">
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-response-btn" data-seq="${row.sequence}">
                                        <i class="bi bi-pencil"></i> 수정
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success save-response-btn" data-seq="${row.sequence}" style="display:none;">
                                        <i class="bi bi-check"></i> 저장
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-response-btn" data-seq="${row.sequence}">
                                        <i class="bi bi-trash"></i> 삭제
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                let modalContent = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3"><strong>신청일:</strong> ${diag.request_date}</div>
                                <div class="col-md-3"><strong>차량번호:</strong> ${diag.vehicle_number}</div>
                                <div class="col-md-3"><strong>출품번호:</strong> ${diag.lot_number}</div>
                                <div class="col-md-3"><strong>주차번호:</strong> ${diag.parking_number}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3"><strong>평가사명:</strong> ${diag.evaluator_name}</div>
                            </div>
                        </div>
                    </div>
                    <form id="responseForm">
                        <input type="hidden" name="diagnosis_id" value="${currentDiagnosisId}">
                        <div class="table-wrapper">
                            <table class="table table-bordered">
                                <thead class="table-fixed-header">
                                    <tr>
                                        <th style="width: 80px;">순</th>
                                        <th>진단신청내역</th>
                                        <th>답변</th>
                                        <th>비고</th>
                                        <th style="width: 150px;">작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </form>
                `;
                
                $('#responseModalBody').html(modalContent);
                
                // 초기 상태 설정: 답변이 없으면 입력 가능, 있으면 비활성화
                $('tbody tr').each(function() {
                    const content = $(this).find('.response-content').val().trim();
                    if (content) {
                        $(this).find('.response-content, .response-note').prop('disabled', true);
                        $(this).find('.edit-response-btn').show();
                        $(this).find('.save-response-btn').hide();
                    } else {
                        // 답변이 없으면 입력 가능하게 활성화
                        $(this).find('.response-content, .response-note').prop('disabled', false);
                        $(this).find('.edit-response-btn').show();
                        $(this).find('.save-response-btn').hide();
                    }
                });
                
                // 수정/저장/삭제 버튼 이벤트 바인딩
                bindResponseFormEvents();
            },
            error: function(xhr, status, error) {
                console.error('Error loading response form:', error);
                $('#responseModalBody').html('<div class="alert alert-danger">답변 폼을 불러올 수 없습니다. 오류: ' + error + '</div>');
            }
        });
    });
    
    // 답변 폼 이벤트 바인딩
    function bindResponseFormEvents() {
        // 수정 버튼
        $(document).off('click', '.edit-response-btn').on('click', '.edit-response-btn', function() {
            const seq = $(this).data('seq');
            const row = $(this).closest('tr');
            const textarea = row.find('.response-content, .response-note');
            
            textarea.prop('disabled', false);
            $(this).hide();
            row.find('.save-response-btn').show();
        });
        
        // 저장 버튼 (개별 행)
        $(document).off('click', '.save-response-btn').on('click', '.save-response-btn', function() {
            const seq = $(this).data('seq');
            const row = $(this).closest('tr');
            const content = row.find('.response-content').val().trim();
            const note = row.find('.response-note').val().trim();
            
            if (!content) {
                alert('답변을 입력해주세요.');
                return;
            }
            
            const data = {
                diagnosis_id: currentDiagnosisId,
                details: [{
                    sequence: parseInt(seq),
                    content: content,
                    note: note
                }]
            };
            
            $.ajax({
                url: '{{ url_for("evaluator_response_save") }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        alert('저장되었습니다.');
                        row.find('.response-content, .response-note').prop('disabled', true);
                        $(this).hide();
                        row.find('.edit-response-btn').show();
                    } else {
                        alert(response.message);
                    }
                }.bind(this)
            });
        });
        
        // 삭제 버튼
        $(document).off('click', '.delete-response-btn').on('click', '.delete-response-btn', function() {
            const seq = $(this).data('seq');
            const row = $(this).closest('tr');
            
            if (confirm('정말 삭제하시겠습니까?')) {
                row.find('.response-content').val('');
                row.find('.response-note').val('');
                row.find('.response-content, .response-note').prop('disabled', false);
                row.find('.save-response-btn').hide();
                row.find('.edit-response-btn').show();
            }
        });
    }
    
    // 답변완료 버튼
    $('#completeResponseBtn').on('click', function() {
        if (!currentDiagnosisId) return;
        
        const details = [];
        $('#responseForm tbody tr').each(function() {
            const seq = $(this).find('td:first').text();
            const content = $(this).find('.response-content').val().trim();
            const note = $(this).find('.response-note').val().trim();
            if (content) {
                details.push({
                    sequence: parseInt(seq),
                    content: content,
                    note: note
                });
            }
        });
        
        if (details.length === 0) {
            alert('답변을 입력해주세요.');
            return;
        }
        
        // 먼저 저장
        $.ajax({
            url: '{{ url_for("evaluator_response_save") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                diagnosis_id: currentDiagnosisId,
                details: details
            }),
            success: function(response) {
                if (response.success) {
                    // 답변완료 처리
                    $.ajax({
                        url: '{{ url_for("evaluator_response_confirm") }}',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({diagnosis_id: currentDiagnosisId}),
                        success: function(response) {
                            if (response.success) {
                                alert('답변이 완료되었습니다.');
                                $('#responseModal').modal('hide');
                                location.reload();
                            }
                        }
                    });
                } else {
                    alert(response.message);
                }
            }
        });
    });
    
    // 작업열 수정 버튼
    $(document).on('click', '.edit-row-btn', function() {
        const id = $(this).data('id');
        const row = $(`#row-${id}`);
        row.addClass('editing');
        row.find('input, select').prop('disabled', false);
        $(this).hide();
        row.find('.save-row-btn').show();
    });
    
    // 작업열 저장 버튼
    $(document).on('click', '.save-row-btn', function() {
        const id = $(this).data('id');
        const row = $(`#row-${id}`);
        const saveBtn = $(this);
        
        // 버튼 비활성화
        saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> 저장 중...');
        
        const data = {
            id: id,
            request_date: row.find('[name="request_date"]').val(),
            status: row.find('[name="status"]').val(),
            vehicle_number: row.find('[name="vehicle_number"]').val() || '',
            lot_number: row.find('[name="lot_number"]').val() || '',
            parking_number: row.find('[name="parking_number"]').val() || ''
        };
        
        console.log('저장 데이터:', data);
        
        $.ajax({
            url: '/evaluator/diagnosis/update',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                console.log('응답:', response);
                saveBtn.prop('disabled', false).html('<i class="bi bi-check"></i> 저장');
                if (response.success) {
                    alert('저장되었습니다.');
                    // 행 비활성화
                    row.removeClass('editing');
                    row.find('input, select').prop('disabled', true);
                    row.find('.edit-row-btn').show();
                    row.find('.save-row-btn').hide();
                } else {
                    alert(response.message || '저장에 실패했습니다.');
                }
            },
            error: function(xhr, status, error) {
                console.error('오류:', xhr, status, error);
                saveBtn.prop('disabled', false).html('<i class="bi bi-check"></i> 저장');
                let errorMessage = '저장 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 403) {
                    errorMessage = '권한이 없습니다.';
                } else if (xhr.status === 404) {
                    errorMessage = '요청을 찾을 수 없습니다.';
                }
                alert(errorMessage);
            }
        });
    });
    
    // 작업열 삭제 버튼
    $('.delete-row-btn').on('click', function() {
        const id = $(this).data('id');
        const row = $(`tr:has([data-id="${id}"])`);
        // 행 전체를 수정 가능하게 만들기 (필요시 구현)
        alert('행 수정 기능은 구현 예정입니다.');
    });
    
    $('.save-row-btn').on('click', function() {
        const id = $(this).data('id');
        alert('행 저장 기능은 구현 예정입니다.');
    });
    
    $('.delete-row-btn').on('click', function() {
        const id = $(this).data('id');
        if (confirm('정말 삭제하시겠습니까?')) {
            alert('행 삭제 기능은 구현 예정입니다.');
        }
    });
});
</script>
{% endblock %}

