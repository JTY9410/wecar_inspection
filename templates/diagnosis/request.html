{% extends "base.html" %}

{% block title %}진단신청 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <a href="{{ url_for('diagnosis_dashboard') }}" class="btn btn-outline-secondary mb-2">
                    <i class="bi bi-house"></i> 진단신청메인페이지로
                </a>
                <h2 class="d-inline ms-3"><i class="bi bi-clipboard-plus"></i> 진단신청</h2>
            </div>
            <div>
                <button type="button" class="btn btn-info btn-lg me-2" id="previewBtn">
                    <i class="bi bi-eye"></i> 확인
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="bi bi-check-circle"></i> 신청
                </button>
            </div>
        </div>
    </div>
    
    <form method="POST" id="diagnosisForm">
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">차량번호 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="vehicle_number" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">출품번호</label>
                        <input type="text" class="form-control" name="lot_number">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">주차번호</label>
                        <input type="text" class="form-control" name="parking_number">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">진단신청내역 (최대 5개)</h5>
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table class="table">
                        <thead class="table-fixed-header">
                            <tr>
                                <th style="width: 80px;">순</th>
                                <th>진단신청내역</th>
                                <th style="width: 150px;">작업</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody">
                            {% for i in range(1, 6) %}
                            <tr data-seq="{{ i }}">
                                <td>
                                    <input type="hidden" name="detail_sequence" value="{{ i }}">
                                    {{ i }}
                                </td>
                                <td>
                                    <textarea class="form-control detail-content" name="detail_content" rows="3" placeholder="진단신청내역을 입력하세요"></textarea>
                                </td>
                                <td>
                                    <div class="btn-group-sm">
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-detail-btn" data-seq="{{ i }}">
                                            <i class="bi bi-pencil"></i> 수정
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success save-detail-btn" data-seq="{{ i }}" style="display:none;">
                                            <i class="bi bi-check"></i> 저장
                                        </button>
                                        <button type="button" class="btn btn-sm btn-danger delete-detail-btn" data-seq="{{ i }}">
                                            <i class="bi bi-trash"></i> 삭제
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 확인 모달 -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">신청내역 확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- 미리보기 내용 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" id="confirmSubmitBtn">
                    <i class="bi bi-check-circle"></i> 신청
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // 초기 상태: 모든 입력 필드 활성화
    $('.detail-content').prop('disabled', false);
    $('.edit-detail-btn').show();
    $('.save-detail-btn').hide();
    
    // 수정 버튼
    $('.edit-detail-btn').on('click', function() {
        const seq = $(this).data('seq');
        const row = $(`tr[data-seq="${seq}"]`);
        const textarea = row.find('.detail-content');
        
        textarea.prop('disabled', false).focus();
        $(this).hide();
        row.find('.save-detail-btn').show();
    });
    
    // 저장 버튼 (로컬 저장)
    $('.save-detail-btn').on('click', function() {
        const seq = $(this).data('seq');
        const row = $(`tr[data-seq="${seq}"]`);
        const textarea = row.find('.detail-content');
        const content = textarea.val().trim();
        
        if (!content) {
            alert('진단신청내역을 입력해주세요.');
            return;
        }
        
        // 로컬 저장 (데이터베이스 저장은 신청 버튼에서 처리)
        textarea.prop('disabled', true);
        $(this).hide();
        row.find('.edit-detail-btn').show();
        alert('저장되었습니다. (신청 버튼을 눌러 최종 제출하세요)');
    });
    
    // 삭제 버튼
    $('.delete-detail-btn').on('click', function() {
        const seq = $(this).data('seq');
        const row = $(`tr[data-seq="${seq}"]`);
        
        if (confirm('정말 삭제하시겠습니까?')) {
            row.find('.detail-content').val('').prop('disabled', false);
            row.find('.save-detail-btn').hide();
            row.find('.edit-detail-btn').show();
        }
    });
    
    // 확인 버튼
    $('#previewBtn').on('click', function() {
        const vehicleNumber = $('[name="vehicle_number"]').val().trim();
        const lotNumber = $('[name="lot_number"]').val().trim();
        const parkingNumber = $('[name="parking_number"]').val().trim();
        const details = [];
        
        $('.detail-content').each(function() {
            const content = $(this).val().trim();
            if (content) {
                const seq = $(this).closest('tr').data('seq');
                details.push({sequence: seq, content: content});
            }
        });
        
        if (!vehicleNumber) {
            alert('차량번호를 입력해주세요.');
            return;
        }
        
        if (details.length === 0) {
            alert('진단신청내역을 입력해주세요.');
            return;
        }
        
        let html = '<div class="card mb-3"><div class="card-body">';
        html += '<div class="row mb-3"><div class="col-md-4"><strong>차량번호:</strong> ' + vehicleNumber + '</div>';
        html += '<div class="col-md-4"><strong>출품번호:</strong> ' + (lotNumber || '-') + '</div>';
        html += '<div class="col-md-4"><strong>주차번호:</strong> ' + (parkingNumber || '-') + '</div></div>';
        html += '</div></div>';
        
        html += '<div class="table-wrapper"><table class="table table-bordered">';
        html += '<thead><tr><th>순</th><th>진단신청내역</th></tr></thead><tbody>';
        details.forEach(function(detail) {
            html += '<tr><td>' + detail.sequence + '</td><td>' + detail.content + '</td></tr>';
        });
        html += '</tbody></table></div>';
        
        $('#previewContent').html(html);
        $('#previewModal').modal('show');
    });
    
    // 신청 버튼 (상단)
    $('#submitBtn').on('click', function() {
        const vehicleNumber = $('[name="vehicle_number"]').val().trim();
        const details = [];
        
        $('.detail-content').each(function() {
            const content = $(this).val().trim();
            if (content) {
                const seq = $(this).closest('tr').data('seq');
                details.push({sequence: seq, content: content});
            }
        });
        
        if (!vehicleNumber) {
            alert('차량번호를 입력해주세요.');
            return;
        }
        
        if (details.length === 0) {
            alert('진단신청내역을 입력해주세요.');
            return;
        }
        
        if (confirm('진단신청을 제출하시겠습니까?')) {
            $('#diagnosisForm').submit();
        }
    });
    
    // 확인 모달의 신청 버튼
    $('#confirmSubmitBtn').on('click', function() {
        $('#previewModal').modal('hide');
        $('#submitBtn').click();
    });
});
</script>
{% endblock %}

