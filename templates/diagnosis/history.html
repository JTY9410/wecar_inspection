{% extends "base.html" %}

{% block title %}진단신청내역 - 위카아라이 진단시스템{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('diagnosis_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-house"></i> 진단신청메인페이지로
                </a>
                <h2 class="d-inline ms-3"><i class="bi bi-clock-history"></i> 진단신청내역</h2>
            </div>
        </div>
    </div>
    
    <div class="filter-section">
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">시작일</label>
                <input type="date" class="form-control" name="start_date" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">종료일</label>
                <input type="date" class="form-control" name="end_date" value="{{ end_date }}">
            </div>
            <div class="col-md-6">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> 검색
                </button>
                <a href="{{ url_for('diagnosis_history_export', fmt='xlsx', start_date=start_date, end_date=end_date) }}" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> 엑셀저장
                </a>
                <a href="{{ url_for('diagnosis_history_export', fmt='pdf', start_date=start_date, end_date=end_date) }}" class="btn btn-danger">
                    <i class="bi bi-file-earmark-pdf"></i> PDF저장
                </a>
            </div>
        </form>
    </div>
    
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead class="table-fixed-header">
                <tr>
                    <th>순</th>
                    <th>신청일</th>
                    <th>상태</th>
                    <th>차량번호</th>
                    <th>출품번호</th>
                    <th>주차번호</th>
                    <th>진단신청내역</th>
                    <th>답변일</th>
                    <th>답변</th>
                    <th>확인</th>
                    <th>평가사</th>
                    <th>번역</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                {% for item in diagnoses[:10] %}
                {% set row = item.row %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ row.request_date }}</td>
                    <td>
                        <span class="badge bg-{% if row.status == '신청' %}secondary{% elif row.status == '답변완료' %}success{% elif row.status == '전송완료' %}info{% else %}warning{% endif %}">
                            {{ row.status }}
                        </span>
                    </td>
                    <td>{{ row.vehicle_number or '' }}</td>
                    <td>{{ row.lot_number or '' }}</td>
                    <td>{{ row.parking_number or '' }}</td>
                    <td class="text-summary">{{ item.request_summary or '' }}</td>
                    <td>{{ row.answer_date or '' }}</td>
                    <td class="text-summary">{{ item.response_summary or '' }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-details-btn" data-id="{{ row.id }}">
                            <i class="bi bi-eye"></i> 확인
                        </button>
                    </td>
                    <td>{{ row.evaluator_name or '' }}</td>
                    <td>
                        {% if row.translated_at %}
                        <a href="{{ url_for('admin_diagnosis_translate', diagnosis_id=row.id) }}" class="btn btn-sm btn-outline-info" target="_blank">
                            <i class="bi bi-translate"></i> 번역
                        </a>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('diagnosis_request') }}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-pencil"></i> 수정
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 확인 팝업 모달 -->
<div class="modal fade" id="detailsModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-clipboard-data"></i> 진단신청 상세</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsModalBody">
                <!-- 내용이 동적으로 로드됨 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    setDefaultDateRange(7);
    
    // 확인 버튼 클릭
    $('.view-details-btn').on('click', function() {
        const diagnosisId = $(this).data('id');
        $('#detailsModalBody').html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">로딩 중...</span></div></div>');
        $('#detailsModal').modal('show');
        
        // 상세 정보 로드 (JSON API 사용)
        $.ajax({
            url: `/admin/diagnosis/${diagnosisId}/json`,
            method: 'GET',
            success: function(response) {
                if (!response.success) {
                    $('#detailsModalBody').html('<div class="alert alert-danger">' + (response.message || '상세 정보를 불러올 수 없습니다.') + '</div>');
                    return;
                }
                
                const diag = response.diagnosis;
                let tableRows = '';
                response.table_data.forEach(function(row) {
                    tableRows += `
                        <tr>
                            <td>${row.sequence}</td>
                            <td>${row.request_content || ''}</td>
                            <td>${row.response_content || ''}</td>
                            <td>${row.note || ''}</td>
                        </tr>
                    `;
                });
                
                let modalContent = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3"><strong>신청일:</strong> ${diag.request_date}</div>
                                <div class="col-md-3"><strong>차량번호:</strong> ${diag.vehicle_number}</div>
                                <div class="col-md-3"><strong>출품번호:</strong> ${diag.lot_number}</div>
                                <div class="col-md-3"><strong>주차번호:</strong> ${diag.parking_number}</div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3"><strong>평가사명:</strong> ${diag.evaluator_name}</div>
                            </div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="table table-bordered">
                            <thead class="table-fixed-header">
                                <tr>
                                    <th>순</th>
                                    <th>진단신청내역</th>
                                    <th>답변내역</th>
                                    <th>비고</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                $('#detailsModalBody').html(modalContent);
            },
            error: function(xhr, status, error) {
                console.error('Error loading details:', error);
                $('#detailsModalBody').html('<div class="alert alert-danger">상세 정보를 불러올 수 없습니다. 오류: ' + error + '</div>');
            }
        });
    });
});
</script>
{% endblock %}

